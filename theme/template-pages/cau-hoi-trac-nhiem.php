<?php

/**
Template Name: Cấu hỏi trắc nhiệm
 */

get_header();
?>

<main>
    <div class="vsn-breadcrumb mb-0">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a class="text-decoration-none" href="https://visana.vn/">Trang chủ</a>
                    </li>
                    <li class="breadcrumb-item active ">Câu trả lời</li>
                </ol>
            </nav>
            <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "BreadcrumbList",
                "itemListElement": [{"@type": "ListItem","position": 1,"item":{"@id": "https://visana.vn/","name": "Trang chủ"}},{"@type": "ListItem","position": 2,"item":{"@id": "","name": "Câu trả lời"}}]
            }
        </script>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            <div class="col-md-12 mb-5 pb-3 text-center">
                <h3 class="hd-1 mb-2">Kiểm tra tỷ lệ đậu </h3>
                <div class="parh">Chỉ cần 2 phút, bạn đã biết được tỷ lệ đậu visa của mình. Kiểm tra ngay!</div>
            </div>

            <div class="col-md-8 offset-md-2">
                <div
                    class="js-vnb-quiz-slider card-ttld-wrap swiper-container swiper-container-initialized swiper-container-horizontal swiper-container-autoheight">
                    <div class="swiper-wrapper" style="height: 602px;">
                        <div class="swiper-slide swiper-slide-active" style="width: 768px;">
                            <div class="card-ttld card">
                                <div class="row no-gutters">
                                    <div class="col-md-6 card-ttld-image bg-img"
                                        style="background-image: url('https://visana.vn/wp-content/themes/visana_v3.6/assets/images/test-ti-le-dau-first-img.png')">
                                    </div>
                                    <div class="col-md-6 card-ttld-form">
                                        <form method="post">
                                            <div>
                                                <p class="hd-2 c-black mb-5 mt-2">Lựa chọn quốc gia bạn sẽ đến</p>
                                                <div class="form-group mb-4">
                                                    <select
                                                        class="js-select-redirect browser-default custom-select custom-select-lg menu-dr form-select"
                                                        name="country" id="">
                                                        <option value="60">Ai Cập</option>
                                                        <option value="59">Algeria</option>
                                                        <option value="58">Angola</option>
                                                        <option value="12">Anh</option>
                                                        <option value="9">Bangladesh </option>
                                                        <option value="41">Brazil</option>
                                                        <option value="17">Bulgaria</option>
                                                        <option value="23">Bỉ</option>
                                                        <option value="42">Bồ Đào Nha</option>
                                                        <option value="14">Canada</option>
                                                        <option value="11">Cuba </option>
                                                        <option value="6">Hong Kong</option>
                                                        <option value="30">Hungary</option>
                                                        <option value="26">Hy Lạp</option>
                                                        <option value="27">Hà Lan</option>
                                                        <option value="3">Hàn Quốc </option>
                                                        <option value="47">Iceland</option>
                                                        <option value="34">Ireland</option>
                                                        <option value="19">Israel </option>
                                                        <option value="50">Liechtenstein</option>
                                                        <option value="46">Lithuania</option>
                                                        <option value="15">Maroc</option>
                                                        <option value="39">Mexico</option>
                                                        <option value="18">Mỹ</option>
                                                        <option value="49">Na Uy</option>
                                                        <option value="1">Nam Phi</option>
                                                        <option value="52">New Caledonia</option>
                                                        <option value="2">New Zealand</option>
                                                        <option value="10">Nga</option>
                                                        <option value="7">Nhật Bản</option>
                                                        <option value="57">Nigeria</option>
                                                        <option value="55">Pakistan</option>
                                                        <option value="25">Pháp</option>
                                                        <option value="24">Phần Lan</option>
                                                        <option value="56">Slovakia</option>
                                                        <option value="44">Séc</option>
                                                        <option value="20">Síp</option>
                                                        <option value="21">Thổ Nhĩ Kỳ</option>
                                                        <option value="51">Thụy Sĩ</option>
                                                        <option value="48">Thụy Điển</option>
                                                        <option value="5">Trung Quốc </option>
                                                        <option value="40">Tây Ban Nha</option>
                                                        <option value="45">Ukraina</option>
                                                        <option value="31">Áo</option>
                                                        <option value="13">Úc</option>
                                                        <option value="28">Ý</option>
                                                        <option value="35">Đan Mạch</option>
                                                        <option value="4">Đài Loan </option>
                                                        <option value="16">Đức</option>
                                                        <option value="8">Ấn Độ</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="card-ttld-btn form-group d-flex justify-content-end">
                                                <button type="submit"
                                                    class="btn-medium d-flex btn btn-primary align-items-center">
                                                    Tiếp theo<span class="icon-arrow-right ml-2"></span>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>
                </div>

                <div class="js-contact-form" style="display: none">
                    <div class="swiper-slide">
                        <div class="card-ttld card">
                            <div class="row no-gutters">
                                <div class="col-md-6 card-ttld-image bg-img"
                                    style="background-image: url('https://visana.vn/wp-content/themes/visana_v3.6/assets/images/test-ti-le-dau-first-img.png')">
                                </div>
                                <div class="col-md-6 card-ttld-form">
                                    <form id="vsn-passing-marks-results" class="js-submit-survey" method="post"
                                        action="https://visana.vn/ket-qua-ti-le-dau">
                                        <input type="hidden" name="f_max_total" value="">
                                        <input type="hidden" name="f_quiz_name" value="">
                                        <input type="hidden" name="deal_product_id" value="">
                                        <input type="hidden" name="f_form_url" value="https://visana.vn/cau-tra-loi/">
                                        <input type="hidden" name="f_quiz_tags" value="">
                                        <input type="hidden" name="f_quiz_lead_source_by_service" value="">
                                        <input type="hidden" name="type_form"
                                            value="form tỷ lệ đậu - https://visana.vn/cau-tra-loi">
                                        <input type="hidden" name="form_id" value="không có form id">
                                        <input id="js-quiz-score" type="hidden" name="f_score">
                                        <input id="js-quiz-items" type="hidden" name="f_quiz_item" value="">
                                        <div>
                                            <p class="hd-2 c-black mb-2 mt-2">Đã có kết quả kiểm tra tỉ lệ đậu visa của
                                                bạn.</p>
                                            <p class="c-black mb-4">Để biết kết quả chi tiết, vui lòng cung cấp các
                                                thông tin sau.</p>
                                            <div class="form-group mb-3">
                                                <input id="f-name" value="" name="f_name" required="" type="text"
                                                    placeholder="Họ và tên">
                                            </div>
                                            <div class="form-group mb-3">
                                                <input id="f-phone" value="" name="f_phone" required="" type="text"
                                                    placeholder="Số điện thoại">
                                            </div>
                                            <div class="form-group mb-3">
                                                <input id="f-email" value="" name="f_email" required="" type="email"
                                                    placeholder="Email"
                                                    pattern="^([a-z0-9\+_\-]+)(\.[a-z0-9\+_\-]+)*@([a-z0-9\-]+\.)+[a-z]{2,6}$">
                                            </div>
                                        </div>
                                        <div class="card-ttld-btn form-group border-top-0">
                                            <input type="submit"
                                                class="btn btn-medium btn-primary p-0 text-white submit-tyledau_finish"
                                                value="Xem kết quả">
                                        </div>
                                        <script type="text/javascript">
                                            jQuery(document).ready(function ($) {
                                                const myaccount = localStorage.getItem('myaccount');
                                                if (myaccount) {
                                                    const userInfor = JSON.parse(myaccount);

                                                    $('#f-name').val(userInfor.fullName);
                                                    $('#f-phone').val(userInfor.phoneNumber);
                                                    $('#f-email').val(userInfor.email);
                                                }

                                                $('#vsn-passing-marks-results').submit(function (event) {
                                                    event.preventDefault();

                                                    // bắt buộc phải có recaptcha
                                                    var ggReCaptcha = $("#ggReCaptcha").val();

                                                    grecaptcha.ready(function () {
                                                        grecaptcha.execute(ggReCaptcha, { action: "submit" }).then(function (token) {
                                                            $('#vsn-passing-marks-results').prepend('<input type="hidden" name="gg-response" value="' + token + '">');
                                                            $('#vsn-passing-marks-results').unbind('submit').submit();
                                                        });
                                                    });
                                                });
                                            });
                                        </script>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    function html_ques_next(data) {
                        var quest = data.quest;
                        var answer = data.answer;

                        var q_id = quest.id;
                        var q_question_group_id = quest.question_group_id;
                        var q_category_id = quest.category_id;
                        var q_thumb = quest.img;
                        var q_title = quest.content;
                        var q_type = (quest.type == 'single') ? 'radio' : 'checkbox';

                        var html_list_answer = '';

                        for (var x = 0; x < answer.length; x++) {
                            answer_index = answer[x];

                            let a_id = answer_index.id;
                            let a_name = answer_index.name;
                            let a_content = answer_index.content;
                            let a_real_score = answer_index.real_score;
                            let a_number_question_next = answer_index.number_question_next;

                            html_list_answer += `
                        <li>
                            <label class="group-checkbox parh" for="q${q_id}-a${a_name}">
                                <input
                                    id="q${q_id}-a${a_name}"
                                    data-score
                                    name="answer-${q_id}"
                                    type="${q_type}"
                                    data-name="${a_name}"
                                    data-content="${a_content}"
                                    value="${a_real_score}"
                                    number_question_next="${a_number_question_next}"
                                />
                                ${a_content}
                                <span></span>
                            </label>
                        </li>
                        `;
                        }

                        var html_all = `
                    <div class="swiper-slide js-quiz-item" data-title="${q_title}">
                        <div class="card-ttld card">
                            <div class="row no-gutters">
                                <div class="col-md-6 card-ttld-image bg-img" style="background-image: url('https://survey.vnbgroup.vn/${q_thumb}')"></div>
                                <div class="col-md-6 card-body">
                                    <h5 class="card-title hd-2 c-black mb-4 mt-2">${q_title}</h5>
                                    <ul>${html_list_answer}</ul>
                                    <div class="card-ttld-btn form-group d-flex justify-content-between">
                                        <button
                                            class="js-next-question btn-medium d-flex btn btn-primary align-items-center"
                                            data-category_id="${q_category_id}"
                                            data-question_group_id="${q_question_group_id}"
                                        >
                                            Tiếp theo<span class="icon-arrow-right ml-2"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                        return html_all;
                    }
                </script>

                <script>
                    jQuery(document).ready(function ($) {
                        var quiz_selector = '.js-vnb-quiz-slider'

                        // Quiz carousel
                        var quizCarousel = new Swiper(quiz_selector, {
                            autoHeight: true,
                            initialSlide: 0,
                            allowTouchMove: false,
                            pagination: {
                                el: quiz_selector + " .pagination"
                            }
                        })

                        var quiz_migrate_data = '';
                        var quizResult = [];

                        // Next question
                        $('body').delegate(quiz_selector + ' .js-next-question', 'click', function () {
                            var ans_status = $(quiz_selector + ' .swiper-slide').eq(quizCarousel.activeIndex).find('input:checked')

                            if (!ans_status.length) return false
                            $(this).css({
                                'pointer-events': 'none',
                                'opacity': '0.5',
                                'transition': 'opacity .3s ease-in-out'
                            });

                            var category_id = $(this).attr('data-category_id');
                            var question_group_id = $(this).attr('data-question_group_id');
                            var ques_next_order = 0;

                            $(quiz_selector + ' .swiper-slide').eq(quizCarousel.activeIndex).find('input:checked').each(function () {
                                return ques_next_order = $(this).attr('number_question_next');
                            });

                            // Ajax lấy câu hỏi tiếp theo
                            // Lấy giá trị câu trả lời
                            // Xử lý ajax trả về câu hỏi tiếp theo
                            if (ques_next_order == 0) {
                                $('.js-vnb-quiz-slider .swiper-wrapper').append($('.js-contact-form').html());

                                $('.js-submit-survey button').click(function () {
                                    let name = $('#f-name').val();
                                    let phone = $('#f-phone').val();
                                    let email = $('#f-email').val();

                                    if (name && phone && email) {
                                        $('.js-submit-survey button').css({
                                            'pointer-events': 'none'
                                        });
                                        $('.js-submit-survey button svg').fadeIn();

                                        setTimeout(function () {
                                            $('.js-submit-survey button').css({
                                                'pointer-events': 'all'
                                            });
                                            $('.js-submit-survey button svg').fadeOut();
                                        }, 10000);
                                    }
                                });

                                quizCarousel.update();
                                quizCarousel.slideTo(quizCarousel.activeIndex + 1);
                            } else {
                                var action = "vnb_quizz_next";
                                var nonce = "afea232101";

                                var data = '{';
                                data += '"action":"' + action + '",';
                                data += '"nonce":"' + nonce + '",';
                                data += '"category_id":"' + category_id + '",';
                                data += '"question_group_id":"' + question_group_id + '",';
                                data += '"ques_next_order":"' + ques_next_order + '"';
                                data += '}';

                                $.ajax({
                                    url: control_vars.ADMIN_AJAX_URL,
                                    type: 'POST',
                                    dataType: 'json',
                                    data: JSON.parse(data),
                                    success: function () { }
                                })
                                    .done(function (response) {
                                        if (response.success == true) {
                                            var ques_next = JSON.parse(response.ques);

                                            // Bổ sung câu hỏi vào giao diện
                                            $('.js-vnb-quiz-slider .swiper-wrapper').append(html_ques_next(ques_next));
                                            quizCarousel.update();
                                            quizCarousel.slideTo(quizCarousel.activeIndex + 1);
                                            return true;
                                        }
                                        if (response.success == false && response.msg) {
                                            // Thêm form lấy thông tin đăng ký
                                            // Làm mới slider

                                            return false
                                        }
                                    })
                                    .fail(function (jqXHR, textStatus) {
                                        console.log("Submit Fail!")
                                    })
                                    .always(function () {
                                        console.log('Event Submit')
                                    })

                                return true;
                            }
                        });

                        $('body').delegate('.js-vnb-quiz-slider', 'change', function () {
                            quizResult = []
                            $(quiz_selector + '[data-score]:checked').each(function () {
                                quizResult.push(parseInt($(this).val()))
                            })

                            // Total Quizz
                            var data_quiz = []
                            $('.js-quiz-item').each(function () {
                                total_answers = {
                                    'max_total': '',
                                    'content': $(this).attr('data-title'),
                                    'list_answer': [

                                    ]
                                }
                                $(this).find('input:checked').each(function () {
                                    var value = {
                                        score: parseInt(this.value),
                                        name: $(this).attr('data-name'),
                                        content: $(this).attr('data-content')
                                    }

                                    total_answers.list_answer.push(value)
                                })
                                data_quiz.push(total_answers)
                            });
                            quiz_migrate_data = JSON.stringify(data_quiz)

                            // Cập nhật điểm, lịch sử câu trả lời
                            document.getElementById('js-quiz-score').value = quizResult.reduce((a, b) => a + b, 0)
                            document.getElementById('js-quiz-items').value = encodeURI(quiz_migrate_data)

                            return quiz_migrate_data
                        });

                        // Previous Quiz
                        $(quiz_selector + ' .js-prev-question').click(function () {
                            quizCarousel.slidePrev()
                        })
                    })
                </script>
            </div>
        </div>
    </div>
</main>

<?php
get_footer();